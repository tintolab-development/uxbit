name: Sync Component Docs to Issues

on:
  push:
    paths:
      - 'docs/components/*.md' # 이 경로의 md가 바뀌면 동작

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 변경된 파일 목록 뽑기
      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            docs/components/*.md

      - name: Create or update issues for changed files
        if: steps.changed.outputs.all_changed_files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # 공용 라벨/담당자 (원하면 수정)
          LABELS=( "type:docs" "area:components" "priority:normal" )
          ASSIGNEES=("your-github-id")

          for FILE in ${{ steps.changed.outputs.all_changed_files }}; do
            BASENAME="$(basename "$FILE")"                 # tinto-section.md
            COMPONENT="${BASENAME%.md}"                    # tinto-section
            TITLE="[Docs] ${COMPONENT}: Guide"

            echo "Processing $FILE -> Title: $TITLE"

            # 이미 열린 이슈가 있는지 검색 (제목 정확 매칭)
            # state:all 로 닫힌 이슈까지 찾고, 있으면 번호만 추출
            ISSUE_NUMBER="$(gh issue list \
              --repo "$REPO" \
              --search "in:title \"$TITLE\"" \
              --state all \
              --json number,title \
              --jq ".[] | select(.title==\"$TITLE\") | .number" | head -n1 || true)"

            if [ -n "$ISSUE_NUMBER" ]; then
              echo "Updating existing issue #$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --title "$TITLE" --body-file "$FILE"

              # 라벨/담당자 보강(중복 추가 허용)
              for L in "${LABELS[@]}"; do gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "$L"; done
              for A in "${ASSIGNEES[@]}"; do gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-assignee "$A"; done

              # 닫힌 이슈였다면 자동 재오픈 (선택)
              gh issue reopen "$ISSUE_NUMBER" --repo "$REPO" || true
            else
              echo "Creating new issue"
              # 라벨/담당자 플래그 만들기
              LABEL_FLAGS=()
              for L in "${LABELS[@]}"; do LABEL_FLAGS+=( --label "$L" ); done
              ASSIGNEE_FLAGS=()
              for A in "${ASSIGNEES[@]}"; do ASSIGNEE_FLAGS+=( --assignee "$A" ); done

              gh issue create \
                --repo "$REPO" \
                --title "$TITLE" \
                "${LABEL_FLAGS[@]}" \
                "${ASSIGNEE_FLAGS[@]}" \
                --body-file "$FILE"
            fi
          done
