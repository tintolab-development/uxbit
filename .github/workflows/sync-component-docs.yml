name: Sync Component Docs to Issues

on:
  push:
    paths:
      - 'apps/stencil-components/docs/components/*.md' # Ïù¥ Í≤ΩÎ°úÏùò mdÍ∞Ä Î∞îÎÄåÎ©¥ ÎèôÏûë

permissions:
  contents: read
  issues: write

jobs:
  writing-component-guidelines:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # üî• ÌïÑÏöîÌïú ÎùºÎ≤®Ïù¥ ÏóÜÏúºÎ©¥ ÏûêÎèô ÏÉùÏÑ±
      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Ensuring labels exist..."
          gh label create "type:docs" --color "1D76DB" --repo "$REPO" --description "Documentation" || true
          gh label create "area:components" --color "0E8A16" --repo "$REPO" --description "Components area" || true
          gh label create "priority:normal" --color "FBCA04" --repo "$REPO" --description "Normal priority" || true

      # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù ÎΩëÍ∏∞
      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            apps/stencil-components/docs/components/*.md

      - name: Create or update issues for changed files
        if: steps.changed.outputs.all_changed_files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Í≥µÏö© ÎùºÎ≤®/Îã¥ÎãπÏûê
          LABELS=( "type:docs" "area:components" "priority:normal" )
          ASSIGNEES=("leezer94")

          for FILE in ${{ steps.changed.outputs.all_changed_files }}; do
            BASENAME="$(basename "$FILE")"
            COMPONENT="${BASENAME%.md}"
            TITLE="[Docs] ${COMPONENT}: Guide"

            echo "Processing $FILE -> Title: $TITLE"

            # Í∏∞Ï°¥ Ïù¥Ïäà Í≤ÄÏÉâ (Ï†ïÌôïÌïú Ï†úÎ™© Îß§Ïπ≠)
            ISSUE_NUMBER="$(gh issue list \
              --repo "$REPO" \
              --search "in:title \"$TITLE\"" \
              --state all \
              --json number,title \
              --jq ".[] | select(.title==\"$TITLE\") | .number" | head -n1 || true)"

            if [ -n "$ISSUE_NUMBER" ]; then
              echo "Updating existing issue #$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --title "$TITLE" --body-file "$FILE"

              # ÎùºÎ≤®/Îã¥ÎãπÏûê Î≥¥Í∞ï
              for L in "${LABELS[@]}"; do
                gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "$L" || true
              done
              for A in "${ASSIGNEES[@]}"; do
                gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-assignee "$A" || true
              done

              # Îã´Ìûå Ïù¥ÏäàÎ©¥ ÏûêÎèô Ïû¨Ïò§Ìîà
              gh issue reopen "$ISSUE_NUMBER" --repo "$REPO" || true

            else
              echo "Creating new issue"

              LABEL_FLAGS=()
              for L in "${LABELS[@]}"; do LABEL_FLAGS+=( --label "$L" ); done

              ASSIGNEE_FLAGS=()
              for A in "${ASSIGNEES[@]}"; do ASSIGNEE_FLAGS+=( --assignee "$A" ); done

              gh issue create \
                --repo "$REPO" \
                --title "$TITLE" \
                "${LABEL_FLAGS[@]}" \
                "${ASSIGNEE_FLAGS[@]}" \
                --body-file "$FILE"
            fi

          done
