name: Sync Component Docs to Issues

on:
  push:
    paths:
      - 'apps/stencil-components/docs/components/*.md' # ì´ ê²½ë¡œì˜ mdê°€ ë°”ë€Œë©´ ë™ì‘
      - 'apps/stencil-components/src/components/**/*.tsx' # ì»´í¬ë„ŒíŠ¸ ì½”ë“œ ë³€ê²½ ì‹œì—ë„ ë™ì‘
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (ê¸°ì¡´ ë¬¸ì„œë“¤ì„ í•œ ë²ˆì— Issueë¡œ ìƒì„±í•  ë•Œ ì‚¬ìš©)

permissions:
  contents: read
  issues: write

jobs:
  writing-component-guidelines:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable corepack and install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm --version

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ğŸ”¥ í•„ìš”í•œ ë¼ë²¨ì´ ì—†ìœ¼ë©´ ìë™ ìƒì„±
      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Ensuring labels exist..."
          gh label create "type:docs" --color "1D76DB" --repo "$REPO" --description "Documentation" || true
          gh label create "area:components" --color "0E8A16" --repo "$REPO" --description "Components area" || true
          gh label create "priority:normal" --color "FBCA04" --repo "$REPO" --description "Normal priority" || true

      # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ë½‘ê¸° (push ì´ë²¤íŠ¸) ë˜ëŠ” ëª¨ë“  íŒŒì¼ (workflow_dispatch)
      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        if: github.event_name == 'push'
        with:
          files: |
            apps/stencil-components/docs/components/*.md

      # workflow_dispatchì¼ ë•Œ ëª¨ë“  ë¬¸ì„œ íŒŒì¼ ì°¾ê¸°
      - name: Get all component docs
        id: all_docs
        if: github.event_name == 'workflow_dispatch'
        run: |
          FILES=$(find apps/stencil-components/docs/components -name "*.md" -type f | tr '\n' ' ')
          echo "all_changed_files=$FILES" >> $GITHUB_OUTPUT
          echo "any_changed=true" >> $GITHUB_OUTPUT
          echo "Found files: $FILES"

      # ì»´í¬ë„ŒíŠ¸ ë¹Œë“œ (custom-elements.json ìƒì„±)
      - name: Build components
        if: steps.changed.outputs.any_changed == 'true' || steps.all_docs.outputs.any_changed == 'true'
        run: |
          pnpm --filter @uxbit/stencil-components run build

      # ì»´í¬ë„ŒíŠ¸ í’ˆì§ˆ í‰ê°€ ì‹¤í–‰ (ì„ íƒì )
      - name: Evaluate component quality
        if: steps.changed.outputs.any_changed == 'true' || steps.all_docs.outputs.any_changed == 'true'
        id: quality
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # MCP ì„œë²„ë¥¼ í†µí•œ í‰ê°€ëŠ” ë¡œì»¬ í™˜ê²½ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê¶Œì¥
          # ì—¬ê¸°ì„œëŠ” ë¬¸ì„œ íŒŒì¼ì—ì„œ í’ˆì§ˆ í‰ê°€ ì„¹ì…˜ì„ ì¶”ì¶œí•˜ê±°ë‚˜
          # ê¸°ë³¸ ì •ë³´ë§Œ í¬í•¨
          echo "Component quality evaluation should be done manually using MCP server"
          echo "Use: evaluate_component_quality tool in Cursor"

      - name: Create or update issues for changed files (push)
        if: github.event_name == 'push' && steps.changed.outputs.all_changed_files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          chmod +x .github/scripts/sync-component-issues.sh
          .github/scripts/sync-component-issues.sh ${{ steps.changed.outputs.all_changed_files }}

      - name: Create or update issues for all files (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && steps.all_docs.outputs.all_changed_files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          chmod +x .github/scripts/sync-component-issues.sh
          .github/scripts/sync-component-issues.sh ${{ steps.all_docs.outputs.all_changed_files }}
